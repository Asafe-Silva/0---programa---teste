{% extends "layout.html" %}
{% block content %}
<div class="container">
    <h1>Administração - Feedbacks</h1>

    <h2>Estatísticas</h2>
    <p>Muito satisfeito: {{ total_muito }} ({{ (total_muito/total*100)|round(2) }}%)</p>
    <p>Satisfeito: {{ total_satisfeito }} ({{ (total_satisfeito/total*100)|round(2) }}%)</p>
    <p>Insatisfeito: {{ total_insatisfeito }} ({{ (total_insatisfeito/total*100)|round(2) }}%)</p>

    <canvas id="grafico" width="400" height="200"></canvas>

    <div class="admin-actions">
        <a href="/logout">Logout</a>
    </div>

    <h2>Histórico</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>Grau</th><th>Data</th><th>Hora</th><th>Dia da Semana</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registros %}
            <tr>
                <td>{{ reg.id }}</td>
                <td>{{ reg.grau }}</td>
                <td>{{ reg.data }}</td>
                <td>{{ reg.hora }}</td>
                <td>{{ reg.dia_semana }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="/exportar/csv">Exportar CSV</a> |
    <a href="/exportar/txt">Exportar TXT</a>
</div>

<!-- botões flutuantes no canto inferior direito (admin) -->
<div class="admin-floating">
    <button id="scrollTopBtn" class="float-btn" title="Ir para o início">⬆️</button>
    <button id="scrollBottomBtn" class="float-btn" title="Ir para o fim">⬇️</button>
</div>

<script>
const ctx = document.getElementById('grafico').getContext('2d');
const grafico = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Muito satisfeito', 'Satisfeito', 'Insatisfeito'],
        datasets: [{
            label: 'Feedbacks',
            data: [{{ total_muito }}, {{ total_satisfeito }}, {{ total_insatisfeito }}],
            backgroundColor: ['#4CAF50', '#FFC107', '#F44336']
        }]
    },
    options: { responsive: true }
});
</script>
<script>
// handlers para botões flutuantes
document.addEventListener('DOMContentLoaded', () => {
    const up = document.getElementById('scrollTopBtn');
    const down = document.getElementById('scrollBottomBtn');
    if (up) up.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    if (down) down.addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));
});
</script>
<!-- Socket.IO client para atualizações em tempo real -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
<script>
    (function(){
        try {
            const socket = io();

            socket.on('init', (data) => {
                // atualizar gráfico
                if (window.grafico && data) {
                    grafico.data.datasets[0].data = [data.total_muito || 0, data.total_satisfeito || 0, data.total_insatisfeito || 0];
                    grafico.update();
                }
                // popular tabela com latest
                if (data.latest && data.latest.length) {
                    const tbody = document.querySelector('table tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        data.latest.forEach(r => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${r.id}</td><td>${r.grau}</td><td>${r.data}</td><td>${r.hora}</td><td>${r.dia_semana}</td>`;
                            tbody.appendChild(tr);
                        });
                    }
                }
            });

            socket.on('stats_update', (s) => {
                if (window.grafico && s) {
                    grafico.data.datasets[0].data = [s.total_muito || 0, s.total_satisfeito || 0, s.total_insatisfeito || 0];
                    grafico.update();
                }
                // atualizar percentuais na página (se existirem elementos)
                try {
                    const total = (s.total_muito||0) + (s.total_satisfeito||0) + (s.total_insatisfeito||0);
                    const pEls = document.querySelectorAll('.stats-percent');
                    // se quiser elementos específicos, você pode criar e atualizar aqui
                } catch(e){}
            });

            socket.on('new_feedback', (r) => {
                try {
                    const tbody = document.querySelector('table tbody');
                    if (tbody) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r.id}</td><td>${r.grau}</td><td>${r.data}</td><td>${r.hora}</td><td>${r.dia_semana}</td>`;
                        // inserir no topo
                        tbody.insertBefore(tr, tbody.firstChild);
                    }
                } catch(e) { console.error(e); }
            });

        } catch (e) { console.warn('Realtime init failed', e); }
    })();
</script>
{% endblock %}
{% block top_buttons %}
    <a href="/" id="inicioBtn" class="topbtn">Início</a>
{% endblock %}
{% block extra_admin_buttons %}{% endblock %}

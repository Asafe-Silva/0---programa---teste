{% extends "layout.html" %}
{% block content %}
<div class="container admin">
    <div class="page-header">
        <div>
            <h1>Administração - Feedbacks</h1>
            <p class="subtitle">Monitoramento em tempo real e insights rápidos para decisões melhores.</p>
        </div>
        <div class="admin-actions">
            <a href="/logout" class="btn-outline">Logout</a>
        </div>
    </div>

    <section class="stats-grid">
        <div class="stat-card">
            <h3>Muito satisfeito</h3>
            <p class="stat-value" id="totalMuito">{{ total_muito }}</p>
            <p class="stat-sub" id="percentMuito">{{ percent_muito }}%</p>
        </div>
        <div class="stat-card">
            <h3>Satisfeito</h3>
            <p class="stat-value" id="totalSatisfeito">{{ total_satisfeito }}</p>
            <p class="stat-sub" id="percentSatisfeito">{{ percent_satisfeito }}%</p>
        </div>
        <div class="stat-card">
            <h3>Insatisfeito</h3>
            <p class="stat-value" id="totalInsatisfeito">{{ total_insatisfeito }}</p>
            <p class="stat-sub" id="percentInsatisfeito">{{ percent_insatisfeito }}%</p>
        </div>
        <div class="stat-card highlight">
            <h3>Total</h3>
            <p class="stat-value" id="totalGeral">{{ total }}</p>
            <p class="stat-sub">Feedbacks</p>
        </div>
    </section>

    <section class="insights-grid">
        <div class="insight-card">
            <h3>Dia mais ativo</h3>
            <p id="diaTop">{{ dia_top }}</p>
        </div>
        <div class="insight-card">
            <h3>Último feedback</h3>
            <p id="ultimoFeedback">{{ ultimo_feedback }}</p>
        </div>
        <div class="insight-card">
            <h3>Exportações rápidas</h3>
            <div class="export-links">
                <a href="/exportar/csv" class="btn-pill">CSV</a>
                <a href="/exportar/txt" class="btn-pill">TXT</a>
                <a href="/exportar/json" class="btn-pill">JSON</a>
            </div>
        </div>
    </section>

    <section class="chart-card">
        <h2>Distribuição de feedbacks</h2>
        <canvas id="grafico" width="400" height="200"></canvas>
    </section>

    <section class="table-card">
        <div class="table-header">
            <h2>Histórico</h2>
            <p>Atualizado automaticamente a cada novo feedback recebido.</p>
        </div>
        <table>
        <thead>
            <tr>
                <th>ID</th><th>Grau</th><th>Data</th><th>Hora</th><th>Dia da Semana</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registros %}
            <tr>
                <td>{{ reg.id }}</td>
                <td>{{ reg.grau }}</td>
                <td>{{ reg.data }}</td>
                <td>{{ reg.hora }}</td>
                <td>{{ reg.dia_semana }}</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </section>
</div>

<!-- botões flutuantes no canto inferior direito (admin) -->
<div class="admin-floating">
    <button id="scrollTopBtn" class="float-btn" title="Ir para o início">⬆️</button>
    <button id="scrollBottomBtn" class="float-btn" title="Ir para o fim">⬇️</button>
</div>

<script>
const ctx = document.getElementById('grafico').getContext('2d');
const grafico = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Muito satisfeito', 'Satisfeito', 'Insatisfeito'],
        datasets: [{
            label: 'Feedbacks',
            data: [{{ total_muito }}, {{ total_satisfeito }}, {{ total_insatisfeito }}],
            backgroundColor: ['#4CAF50', '#FFC107', '#F44336']
        }]
    },
    options: { responsive: true }
});
</script>
<script>
// handlers para botões flutuantes
document.addEventListener('DOMContentLoaded', () => {
    const up = document.getElementById('scrollTopBtn');
    const down = document.getElementById('scrollBottomBtn');
    if (up) up.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    if (down) down.addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));
});
</script>
<!-- Socket.IO client para atualizações em tempo real -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
<script>
    (function(){
        try {
            const socket = io();

            socket.on('init', (data) => {
                // atualizar gráfico
                if (window.grafico && data) {
                    grafico.data.datasets[0].data = [data.total_muito || 0, data.total_satisfeito || 0, data.total_insatisfeito || 0];
                    grafico.update();
                }
                if (data) {
                    atualizarResumo(data);
                }
                // popular tabela com latest
                if (data.latest && data.latest.length) {
                    const tbody = document.querySelector('table tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        data.latest.forEach(r => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${r.id}</td><td>${r.grau}</td><td>${r.data}</td><td>${r.hora}</td><td>${r.dia_semana}</td>`;
                            tbody.appendChild(tr);
                        });
                    }
                }
            });

            function atualizarResumo(s) {
                const total = (s.total_muito || 0) + (s.total_satisfeito || 0) + (s.total_insatisfeito || 0);
                const percent = (value) => total ? ((value / total) * 100).toFixed(2) : '0.00';
                const setText = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                };
                setText('totalMuito', s.total_muito || 0);
                setText('totalSatisfeito', s.total_satisfeito || 0);
                setText('totalInsatisfeito', s.total_insatisfeito || 0);
                setText('totalGeral', total);
                setText('percentMuito', `${percent(s.total_muito || 0)}%`);
                setText('percentSatisfeito', `${percent(s.total_satisfeito || 0)}%`);
                setText('percentInsatisfeito', `${percent(s.total_insatisfeito || 0)}%`);
            }

            socket.on('stats_update', (s) => {
                if (window.grafico && s) {
                    grafico.data.datasets[0].data = [s.total_muito || 0, s.total_satisfeito || 0, s.total_insatisfeito || 0];
                    grafico.update();
                }
                if (s) {
                    atualizarResumo(s);
                }
            });

            socket.on('new_feedback', (r) => {
                try {
                    const tbody = document.querySelector('table tbody');
                    if (tbody) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r.id}</td><td>${r.grau}</td><td>${r.data}</td><td>${r.hora}</td><td>${r.dia_semana}</td>`;
                        // inserir no topo
                        tbody.insertBefore(tr, tbody.firstChild);
                    }
                    const ultimo = document.getElementById('ultimoFeedback');
                    if (ultimo) {
                        ultimo.textContent = `${r.data} ${r.hora}`;
                    }
                } catch(e) { console.error(e); }
            });

        } catch (e) { console.warn('Realtime init failed', e); }
    })();
</script>
{% endblock %}
{% block top_buttons %}
    <a href="/" id="inicioBtn" class="topbtn">Início</a>
{% endblock %}
{% block extra_admin_buttons %}{% endblock %}
